

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NR PDSCH Throughput with HARQ &mdash; NeoRadium 0.4.0 Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/nbsphinx-code-cells.css?v=2aa19091" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/neoradium.css?v=45ad03f8" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=6c02275b"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Using HARQ" href="../HARQ/Harq.html" />
    <link rel="prev" title="Calculating BER/BLER for PDSCH Communication with LDPC" href="PDSCH-BLER.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            NeoRadium 0.4.0
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">What is NeoRadium?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../Playground.html">Playground</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../Playground.html#antenna">Antenna</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Playground.html#stochastic-channel-models">Stochastic Channel Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Playground.html#trajectory-based-channel-model">Trajectory-based Channel Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Playground.html#channel-state-information-reference-signals-csi-rs">Channel State Information Reference Signals (CSI-RS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Playground.html#dmrs-and-ptrs">DMRS and PTRS</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../Playground.html#physical-downlink-shared-channel-pdsch">Physical Downlink Shared Channel (PDSCH)</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="PDSCH-endToEnd.html">PDSCH end-to-end communication</a></li>
<li class="toctree-l3"><a class="reference internal" href="PDSCH-BER.html">Calculating bit error rate of PDSCH communication</a></li>
<li class="toctree-l3"><a class="reference internal" href="PDSCH-BLER.html">Calculating BER/BLER for PDSCH Communication with LDPC</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">NR PDSCH Throughput with HARQ</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../Playground.html#hybrid-automatic-repeat-request-harq">Hybrid Automatic Repeat reQuest (HARQ)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Playground.html#a-deep-learning-case-study">A Deep Learning Case Study</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Playground.html#research-papers">Research Papers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Playground.html#other-examples">Other Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Playground.html#comparing-with-matlab">Comparing with Matlab</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../API/Carrier.html">Carriers and Bandwidth Parts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/Grid.html">Resource Grid</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/Waveform.html">Waveform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/Modulation.html">Modulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/RefSig.html">Reference Signals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/PhyChannels.html">Physical Channels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/ChanCode.html">Channel Coding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/Harq.html">HARQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/Antenna.html">Antenna</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/Channels.html">Channel Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/Random.html">Random Number Generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/DeepMIMO.html">DeepMIMO and UE Trajectories</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/SnrHelper.html">SnrScheduler</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">NeoRadium 0.4.0</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../Playground.html">Playground</a></li>
      <li class="breadcrumb-item active">NR PDSCH Throughput with HARQ</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/source/Playground/Notebooks/PDSCH/PDSCH-Throughput.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="NR-PDSCH-Throughput-with-HARQ">
<h1>NR PDSCH Throughput with HARQ<a class="headerlink" href="#NR-PDSCH-Throughput-with-HARQ" title="Link to this heading">ÔÉÅ</a></h1>
<p>This notebook demonstrates how to measure the physical downlink shared channel (PDSCH) throughput of a 5G New Radio (NR) link, as specified in the 3GPP NR standard. It is similar to the MATLAB example <a class="reference external" href="https://www.mathworks.com/help/5g/ug/nr-pdsch-throughput.html">NR PDSCH Throughput</a> and showcases the use of the following NeoRadium features:</p>
<ul class="simple">
<li><p>Carrier and Bandwidth Part classes.</p></li>
<li><p>PDSCH and DMRS objects.</p></li>
<li><p>LDPC and HARQ capabilities.</p></li>
<li><p>CDL channel model and extraction of channel matrix and precoding matrix.</p></li>
<li><p>Resource grids, populating them, and applying channel models to them.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">neoradium</span><span class="w"> </span><span class="kn">import</span> <span class="n">Carrier</span><span class="p">,</span> <span class="n">PDSCH</span><span class="p">,</span> <span class="n">CdlChannel</span><span class="p">,</span> <span class="n">AntennaPanel</span><span class="p">,</span> <span class="n">LdpcEncoder</span><span class="p">,</span> <span class="n">random</span><span class="p">,</span> <span class="n">HarqEntity</span><span class="p">,</span> <span class="n">SnrScheduler</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a Carrier object with 51 resource blocks and 30KHz subcarrier spacing</span>
<span class="n">carrier</span> <span class="o">=</span> <span class="n">Carrier</span><span class="p">(</span><span class="n">numRbs</span><span class="o">=</span><span class="mi">51</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">carrier</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>
<span class="n">bwp</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">curBwp</span>                      <span class="c1"># The only bandwidth part in the carrier</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Carrier Properties:
  Cell Id:              1
  Bandwidth Parts:      1
  Active BWP:           0
  Bandwidth Part 0:
    Resource Blocks:    51 RBs starting at 0 (612 subcarriers)
    Subcarrier Spacing: 30 kHz
    CP Type:            normal
    Bandwidth:          18.36 MHz
    symbolsPerSlot:     14
    slotsPerSubFrame:   2
    nFFT:               1024
    frameNo:            0
    slotNo:             0

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize the modulation and code rate.</span>
<span class="n">modulation</span> <span class="o">=</span> <span class="s1">&#39;16QAM&#39;</span>
<span class="n">codeRate</span> <span class="o">=</span> <span class="mi">490</span><span class="o">/</span><span class="mi">1024</span>

<span class="c1"># Create a PDSCH onject with 2 tramsmission layers</span>
<span class="n">pdsch</span> <span class="o">=</span> <span class="n">PDSCH</span><span class="p">(</span><span class="n">bwp</span><span class="p">,</span> <span class="n">interleavingBundleSize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">numLayers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nID</span><span class="o">=</span><span class="n">carrier</span><span class="o">.</span><span class="n">cellId</span><span class="p">)</span>
<span class="n">pdsch</span><span class="o">.</span><span class="n">setDMRS</span><span class="p">(</span><span class="n">prgSize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">configType</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">additionalPos</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">otherCdmGroups</span><span class="o">=</span><span class="p">[])</span>
<span class="n">pdsch</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>

<span class="c1"># Create an LDPC encoder object using base graph 1 and passing modulation and code rate settings</span>
<span class="n">ldpcEncoder</span> <span class="o">=</span> <span class="n">LdpcEncoder</span><span class="p">(</span><span class="n">baseGraphNo</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="n">modulation</span><span class="o">=</span><span class="n">modulation</span><span class="p">,</span> <span class="n">txLayers</span><span class="o">=</span><span class="n">pdsch</span><span class="o">.</span><span class="n">numLayers</span><span class="p">,</span> <span class="n">targetRate</span><span class="o">=</span><span class="n">codeRate</span><span class="p">)</span>

<span class="c1"># HARQ configuration:</span>
<span class="n">harqType</span> <span class="o">=</span> <span class="s2">&quot;IR&quot;</span>                                     <span class="c1"># &quot;IR&quot; -&gt; &quot;Incremental Redundancy&quot;, &quot;CC&quot; -&gt; &quot;Chase Combining&quot;</span>
<span class="n">numProc</span> <span class="o">=</span> <span class="mi">16</span>                                        <span class="c1"># Number of HARQ processes</span>
<span class="n">harq</span> <span class="o">=</span> <span class="n">HarqEntity</span><span class="p">(</span><span class="n">ldpcEncoder</span><span class="p">,</span> <span class="n">harqType</span><span class="p">,</span> <span class="n">numProc</span><span class="p">)</span>   <span class="c1"># Create the HARQ entity</span>
<span class="n">harq</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>

<span class="c1"># Create the CDL channel model</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">CdlChannel</span><span class="p">(</span><span class="n">bwp</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">delaySpread</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">carrierFreq</span><span class="o">=</span><span class="mf">4e9</span><span class="p">,</span> <span class="n">dopplerShift</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                     <span class="n">txAntenna</span> <span class="o">=</span> <span class="n">AntennaPanel</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">polarization</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">),</span>                         <span class="c1"># 8 TX antenna</span>
                     <span class="n">rxAntenna</span> <span class="o">=</span> <span class="n">AntennaPanel</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">polarization</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">beamWidth</span><span class="o">=</span><span class="p">[</span><span class="mi">75</span><span class="p">,</span><span class="mi">360</span><span class="p">]),</span>     <span class="c1"># 2 RX antenna, Omni-directional</span>
                     <span class="n">rxOrientation</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>                                                   <span class="c1"># Default is [180,0,0]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

PDSCH Properties:
  mappingType: A
  nID: 1
  rnti: 1
  numLayers: 2
  numCodewords: 1
  modulation: 16QAM
  portSet: [0, 1]
  symSet:   0   1   2   3   4   5   6   7   8   9  10  11  12  13
  prbSet:   0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19
           20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39
           40  41  42  43  44  45  46  47  48  49  50
  interleavingBundleSize: 0
  PRG Size: Wideband
  Bandwidth Part:
    Resource Blocks:    51 RBs starting at 0 (612 subcarriers)
    Subcarrier Spacing: 30 kHz
    CP Type:            normal
    Bandwidth:          18.36 MHz
    symbolsPerSlot:     14
    slotsPerSubFrame:   2
    nFFT:               1024
    frameNo:            0
    slotNo:             0
  DMRS:
    configType: 2
    nIDs: []
    scID: 0
    sameSeq: 1
    symbols: Single
    typeA1stPos: 2
    additionalPos: 2
    cdmGroups: [0, 0]
    deltaShifts: [0, 0]
    allCdmGroups: [0]
    symSet: [ 2  7 11]
    REs (before shift): [0, 1, 6, 7]
    epreRatioDb: 0 (dB)


HARQ Entity Properties:
  HARQ Type:            IR
  Num. Processes:       16
  Num. Codewords:       1
  RV sequence:          [0, 2, 3, 1]
  maxTries:             4
  Encoder:
    Base Graph:         1
    Modulation:         16QAM
    Number of layers:   2
    Target Rate:        0.478515625
  Decoder:
    Base Graph:         1
    Modulation:         16QAM
    Number of layers:   2


CDL-C Channel Properties:
  carrierFreq:          4 GHz
  normalizeGains:       True
  normalizeOutput:      True
  txDir:                Downlink
  filterLen:            16 samples
  delayQuantSize:       64
  stopBandAtten:        80 dB
  dopplerShift:         5 Hz
  coherenceTime:        84.628 milliseconds
  delaySpread:          300 ns
  ueDirAZ:              0.0¬∞, 90.0¬∞
  Cross Pol. Power:     7 dB
  angleSpreads:         2¬∞ 15¬∞ 3¬∞ 7¬∞
  TX Antenna:
    Total Elements:     8
    spacing:            0.5ùúÜ, 0.5ùúÜ
    shape:              1 rows x 4 columns
    polarization:       x
  RX Antenna:
    Total Elements:     2
    spacing:            0.5ùúÜ, 0.5ùúÜ
    shape:              1 rows x 1 columns
    polarization:       +
  hasLOS:               False
  NLOS Paths (24):
    Delays (ns):        0.000 62.97 66.57 69.87 65.28 190.9 193.4 196.8 197.5 238.0 246.3 280.0
                        368.5 392.4 651.1 813.1 1277. 1380. 1647. 1682. 1891. 1991. 2112. 2595.
    Powers (dB):        -4.40 -1.20 -3.50 -5.20 -2.50 0.000 -2.20 -3.90 -7.40 -7.10 -10.7 -11.1
                        -5.10 -6.80 -8.70 -13.2 -13.9 -13.9 -15.8 -17.1 -16.0 -15.7 -21.6 -22.8
    AODs (Deg):         -47  -23  -23  -23  -41  0    0    0    73   -64  80   -97
                        -55  -64  -78  103  99   89   -102 92   93   107  119  -124
    AOAs (Deg):         -101 120  120  120  -128 170  170  170  55   66   -48  47
                        68   -69  82   31   -16  4    -14  10   6    1    -22  34
    ZODs (Deg):         97   99   99   99   101  99   99   99   105  95   106  94
                        104  104  93   104  95   93   92   107  93   93   105  108
    ZOAs (Deg):         88   72   72   72   70   75   75   75   67   64   71   60
                        91   60   61   101  62   67   53   62   52   62   58   57

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print header lines:</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SNR(dB)  Tx Bits     Rx Bits     Throughput(%)  TX Blocks  RX Blocks  BLER(%)  Retry Mean  time(Sec.)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------  ----------  ----------  -------------  ---------  ---------  -------  ----------  ----------&quot;</span><span class="p">)</span>

<span class="n">snrScheduler</span> <span class="o">=</span> <span class="n">SnrScheduler</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">loSnrVal</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hiSnrVal</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>      <span class="c1"># Start at 6 dB, use increments of 0.2 dB</span>
<span class="n">numSlots</span> <span class="o">=</span> <span class="mi">1000</span>                                                 <span class="c1"># The number of slots transmitted for each SNR value</span>
<span class="k">for</span> <span class="n">snrDb</span> <span class="ow">in</span> <span class="n">snrScheduler</span><span class="p">:</span>
    <span class="n">random</span><span class="o">.</span><span class="n">setSeed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
    <span class="n">channel</span><span class="o">.</span><span class="n">restart</span><span class="p">()</span>                                           <span class="c1"># Reset the channel and the bandwidth part associated with it</span>
    <span class="n">harq</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>                                                <span class="c1"># Reset HARQ state and buffers</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>                                            <span class="c1"># Start the timer</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numSlots</span><span class="p">):</span>                                   <span class="c1"># The inner loop doing &#39;numSlot&#39; transmissions</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">bwp</span><span class="o">.</span><span class="n">createGrid</span><span class="p">(</span><span class="n">pdsch</span><span class="o">.</span><span class="n">numLayers</span><span class="p">)</span>                  <span class="c1"># Create a resource grid with 2 layers</span>
        <span class="n">pdsch</span><span class="o">.</span><span class="n">allocateResources</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>                           <span class="c1"># Allocat PDSCH resources including DMRS</span>
        <span class="n">txBlockSizes</span> <span class="o">=</span> <span class="n">pdsch</span><span class="o">.</span><span class="n">getTxBlockSize</span><span class="p">(</span><span class="n">codeRate</span><span class="p">)</span>           <span class="c1"># Calculate the Transport Block Size (TBS)</span>
        <span class="n">numBits</span> <span class="o">=</span> <span class="n">pdsch</span><span class="o">.</span><span class="n">getBitSizes</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>                       <span class="c1"># Total number of PDSCH data bits available in the resource grid</span>

        <span class="c1"># Preparing the transport blocks</span>
        <span class="n">txBlocks</span> <span class="o">=</span> <span class="p">[]</span>                                           <span class="c1"># Transport blocks, one per codeword.</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">harq</span><span class="o">.</span><span class="n">numCW</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">harq</span><span class="o">.</span><span class="n">needNewData</span><span class="p">[</span><span class="n">c</span><span class="p">]:</span>                             <span class="c1"># New transmission.</span>
                <span class="n">txBlocks</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">random</span><span class="o">.</span><span class="n">bits</span><span class="p">(</span><span class="n">txBlockSizes</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="p">]</span>    <span class="c1"># Create random bits for new transmissions</span>
            <span class="k">else</span><span class="p">:</span>                                               <span class="c1"># Retransmission</span>
                <span class="n">txBlocks</span> <span class="o">+=</span> <span class="p">[</span> <span class="kc">None</span> <span class="p">]</span>                            <span class="c1"># Set transport block to None to indicate a retransmission</span>

        <span class="c1"># The following function returns a coded, rate-matched bitstream, ready for transmission/retransmission</span>
        <span class="n">rateMatchedCodeBlocks</span> <span class="o">=</span> <span class="n">harq</span><span class="o">.</span><span class="n">getRateMatchedCodeBlocks</span><span class="p">(</span><span class="n">txBlocks</span><span class="p">,</span> <span class="n">numBits</span><span class="p">)</span>

        <span class="n">pdsch</span><span class="o">.</span><span class="n">populateGrid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">rateMatchedCodeBlocks</span><span class="p">)</span>         <span class="c1"># Map/modulate the data to the resource grid</span>

        <span class="n">channelMatrix</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">getChannelMatrix</span><span class="p">()</span>              <span class="c1"># Get channel matrix (Assuming perfect channel estimation)</span>
        <span class="n">precoder</span> <span class="o">=</span> <span class="n">pdsch</span><span class="o">.</span><span class="n">getPrecodingMatrix</span><span class="p">(</span><span class="n">channelMatrix</span><span class="p">)</span>      <span class="c1"># Get precoding matrix based on the channel matrix</span>

        <span class="n">precodedGrid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">precode</span><span class="p">(</span><span class="n">precoder</span><span class="p">)</span>                   <span class="c1"># Perform precoding</span>

        <span class="n">rxGrid</span> <span class="o">=</span> <span class="n">precodedGrid</span><span class="o">.</span><span class="n">applyChannel</span><span class="p">(</span><span class="n">channelMatrix</span><span class="p">)</span>       <span class="c1"># Apply the channel to the precoded resource (Freq. domain)</span>
        <span class="n">noisyRxGrid</span> <span class="o">=</span> <span class="n">rxGrid</span><span class="o">.</span><span class="n">addNoise</span><span class="p">(</span><span class="n">snrDb</span><span class="o">=</span><span class="n">snrDb</span><span class="p">,</span> <span class="n">useRxPower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Add noise (Using RX power to calcualte Noise Power)</span>

        <span class="c1"># Calculate the channel matrix with the precoding effect. This is assuming perfect channel estimation. For practical</span>
        <span class="c1"># channel estimation we can use the DMRS reference signals and use the &quot;estimateChannelLS&quot; method of resource grid object.</span>
        <span class="n">precodingChannelMatrix</span> <span class="o">=</span> <span class="n">channelMatrix</span> <span class="o">@</span> <span class="n">precoder</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>

        <span class="c1"># Use the channel matrix (with precoding effect) to equalize the received resource grid</span>
        <span class="n">eqGrid</span><span class="p">,</span> <span class="n">llrScales</span> <span class="o">=</span> <span class="n">noisyRxGrid</span><span class="o">.</span><span class="n">equalize</span><span class="p">(</span><span class="n">precodingChannelMatrix</span><span class="p">)</span>

        <span class="c1"># Demodulate the equalized resource grid (eqGrid) to get the Log-Likelihood values</span>
        <span class="n">llrs</span> <span class="o">=</span> <span class="n">pdsch</span><span class="o">.</span><span class="n">getLLRsFromGrid</span><span class="p">(</span><span class="n">eqGrid</span><span class="p">,</span> <span class="n">pdsch</span><span class="o">.</span><span class="n">dataIndices</span><span class="p">,</span> <span class="n">llrScales</span><span class="p">)</span>

        <span class="c1"># Use HARQ entity to decode the LLRs to transport blocks</span>
        <span class="n">decodedTxBlocks</span><span class="p">,</span> <span class="n">blockErrors</span> <span class="o">=</span> <span class="n">harq</span><span class="o">.</span><span class="n">decodeLLRs</span><span class="p">(</span><span class="n">llrs</span><span class="p">,</span> <span class="n">txBlockSizes</span><span class="p">,</span> <span class="n">numIter</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Get the statistics from HARQ entity and print them:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="si">%-7d</span><span class="s2">  </span><span class="si">%-10d</span><span class="s2">  </span><span class="si">%-10d</span><span class="s2">  </span><span class="si">%-13.2f</span><span class="s2">  </span><span class="si">%-9d</span><span class="s2">  </span><span class="si">%-9d</span><span class="s2">  </span><span class="si">%-7.2f</span><span class="s2">  </span><span class="si">%-10.2f</span><span class="s2">  </span><span class="si">%-10.2f</span><span class="s2">&quot;</span>
              <span class="o">%</span><span class="p">(</span><span class="n">snrDb</span><span class="p">,</span> <span class="n">harq</span><span class="o">.</span><span class="n">totalTxBits</span><span class="p">,</span> <span class="n">harq</span><span class="o">.</span><span class="n">totalRxBits</span><span class="p">,</span> <span class="n">harq</span><span class="o">.</span><span class="n">throughput</span><span class="p">,</span> <span class="n">harq</span><span class="o">.</span><span class="n">totalTxBlocks</span><span class="p">,</span>
                <span class="n">harq</span><span class="o">.</span><span class="n">totalRxBlocks</span><span class="p">,</span> <span class="n">harq</span><span class="o">.</span><span class="n">bler</span><span class="p">,</span> <span class="n">harq</span><span class="o">.</span><span class="n">meanTries</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">channel</span><span class="o">.</span><span class="n">goNext</span><span class="p">()</span>
        <span class="n">harq</span><span class="o">.</span><span class="n">goNext</span><span class="p">()</span>

    <span class="n">snrScheduler</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">harq</span><span class="o">.</span><span class="n">throughput</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
SNR(dB)  Tx Bits     Rx Bits     Throughput(%)  TX Blocks  RX Blocks  BLER(%)  Retry Mean  time(Sec.)
-------  ----------  ----------  -------------  ---------  ---------  -------  ----------  ----------
6        30216000    3263328     10.80          1000       108        89.20    3.54        158.70
5        30216000    423024      1.40           1000       14         98.60    3.94        158.07
4        30216000    0           0.00           1000       0          100.00   4.00        159.37
3        30216000    0           0.00           1000       0          100.00   4.00        159.64
7        30216000    5166936     17.10          1000       171        82.90    3.03        161.71
8        30216000    6738168     22.30          1000       223        77.70    2.61        167.97
9        30216000    8218752     27.20          1000       272        72.80    2.19        173.80
10       30216000    10756896    35.60          1000       356        64.40    1.62        178.26
11       30216000    12751152    42.20          1000       422        57.80    1.33        184.86
12       30216000    13566984    44.90          1000       449        55.10    1.20        188.20
13       30216000    15198648    50.30          1000       503        49.70    0.98        194.23
14       30216000    18099384    59.90          1000       599        40.10    0.67        204.43
15       30216000    22208760    73.50          1000       735        26.50    0.36        222.47
16       30216000    24777120    82.00          1000       820        18.00    0.22        231.26
17       30216000    26499432    87.70          1000       877        12.30    0.14        238.67
18       30216000    27345480    90.50          1000       905        9.50     0.10        241.45
19       30216000    28644768    94.80          1000       948        5.20     0.05        246.40
20       30216000    29792976    98.60          1000       986        1.40     0.01        251.06
21       30216000    30095136    99.60          1000       996        0.40     0.00        252.46
22       30216000    30216000    100.00         1000       1000       0.00     0.00        252.83
23       30216000    30216000    100.00         1000       1000       0.00     0.00        252.05
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Draw the throughput graph:</span>
<span class="n">snrDbs</span><span class="p">,</span> <span class="n">throughputs</span> <span class="o">=</span> <span class="n">snrScheduler</span><span class="o">.</span><span class="n">getSnrsAndData</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">snrDbs</span><span class="p">,</span> <span class="n">throughputs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;PDSCH throughput at different SNR values&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;SNR (dB)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">snrDbs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Throughput (%)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/source_Playground_Notebooks_PDSCH_PDSCH-Throughput_5_0.png" src="../../../../_images/source_Playground_Notebooks_PDSCH_PDSCH-Throughput_5_0.png" />
</div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="PDSCH-BLER.html" class="btn btn-neutral float-left" title="Calculating BER/BLER for PDSCH Communication with LDPC" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../HARQ/Harq.html" class="btn btn-neutral float-right" title="Using HARQ" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, InterDigital, Inc. All Rights Reserved.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>